#!/bin/bash

# Define whitelist location
WHITELIST="/etc/whitelist"

# Create and populate the whitelist
touch "$WHITELIST"
echo /usr/bin/passwd >> "$WHITELIST"
echo /usr/bin/sudo >> "$WHITELIST"
echo /bin/ping >> "$WHITELIST"

# Remove SUID/SGID bit from non-whitelisted files
find / -perm /6000 2>/dev/null | while read -r file; do
    if ! grep -qx "$file" "$WHITELIST"; then
        echo "Removing SUID or SGID bit from $file"
        chmod u-s,g-s "$file"
    else
        echo "Keeping SUID or SGID bit for essential file: $file"
    fi
done

# Remove world-writable permissions
find / -perm -o=w 2>/dev/null | while read -r file; do
    echo "Removing world-writable permissions from $file"
    chmod o-w "$file"
done

# Optionally remove the whitelist file if it should be temporary
rm "$WHITELIST"

echo "current perms for passwd, shadow, and group are: "
ls -l /etc/passwd /etc/group /etc/shadow

chmod 644 /etc/passwd
chown root:root /etc/passwd

chmod 644 /etc/group
chown root:root /etc/group

chmod 640 /etc/shadow
chown root:shadow /etc/shadow

echo "new perms for passwd, shadow, and group are: "
ls -l /etc/passwd /etc/group /etc/shadow

echo "underprivalidged user or group may own a configuaation file:"
ls -l /etc/ | awk '{print $3":"$4,$9}' | grep -v "^root:root" | grep -v "^:"
